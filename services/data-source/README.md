# æ•°æ®æºæœåŠ¡ (Data Source Service)

å†å²æ–‡æœ¬é¡¹ç›®çš„æ•°æ®è·å–å¾®æœåŠ¡ï¼Œè´Ÿè´£ä»å¤šä¸ªå¹³å°çˆ¬å–å†…å®¹ã€ä»£ç†ç®¡ç†å’Œæ•°æ®å¤„ç†ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.9+
- MongoDB 5.0+
- Redis 7.0+
- Docker & Docker Compose (å¯é€‰)

### æœ¬åœ°å¼€å‘

1. **å…‹éš†ä»£ç å¹¶å®‰è£…ä¾èµ–**
   ```bash
   cd services/data-source
   pip install -r requirements.txt
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   cp .env.example .env
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ç­‰ä¿¡æ¯
   ```

3. **å¯åŠ¨æ•°æ®åº“æœåŠ¡**
   ```bash
   # ä½¿ç”¨Docker Composeå¯åŠ¨ä¾èµ–æœåŠ¡
   docker-compose up -d mongo redis consul
   ```

4. **è¿è¡ŒæœåŠ¡**
   ```bash
   python -m src.main
   ```

5. **è®¿é—®APIæ–‡æ¡£**
   - Swagger UI: http://localhost:8000/docs
   - ReDoc: http://localhost:8000/redoc

### Dockeréƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t data-source-service .

# ä½¿ç”¨Docker Composeè¿è¡Œå®Œæ•´æœåŠ¡æ ˆ
docker-compose up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
```

### Kuberneteséƒ¨ç½²

```bash
# åˆ›å»ºå‘½åç©ºé—´å’Œé…ç½®
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/configmap.yaml

# éƒ¨ç½²æœåŠ¡
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml

# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
kubectl get pods -n data-source
```

## ğŸ“š API æ¥å£

### çˆ¬è™«ç®¡ç†
- `POST /api/v1/crawlers/` - åˆ›å»ºçˆ¬è™«ä»»åŠ¡
- `POST /api/v1/crawlers/{task_id}/start` - å¯åŠ¨ä»»åŠ¡
- `POST /api/v1/crawlers/{task_id}/stop` - åœæ­¢ä»»åŠ¡
- `GET /api/v1/crawlers/{task_id}/status` - è·å–ä»»åŠ¡çŠ¶æ€
- `GET /api/v1/crawlers/` - è·å–ä»»åŠ¡åˆ—è¡¨
- `GET /api/v1/crawlers/statistics` - è·å–ç»Ÿè®¡ä¿¡æ¯

### å†…å®¹ç®¡ç†
- `POST /api/v1/content/` - æ‰‹åŠ¨æ·»åŠ å†…å®¹
- `POST /api/v1/content/batch` - æ‰¹é‡æ·»åŠ å†…å®¹
- `POST /api/v1/content/upload` - æ–‡ä»¶å¯¼å…¥å†…å®¹
- `GET /api/v1/content/` - è·å–å†…å®¹åˆ—è¡¨
- `GET /api/v1/content/{content_id}` - è·å–å†…å®¹è¯¦æƒ…
- `PUT /api/v1/content/{content_id}` - æ›´æ–°å†…å®¹
- `DELETE /api/v1/content/{content_id}` - åˆ é™¤å†…å®¹
- `GET /api/v1/content/statistics/overview` - è·å–å†…å®¹ç»Ÿè®¡

### ä»£ç†ç®¡ç†
- `GET /api/v1/proxy/` - è·å–ä»£ç†åˆ—è¡¨
- `GET /api/v1/proxy/active` - è·å–å¯ç”¨ä»£ç†
- `GET /api/v1/proxy/best` - è·å–æœ€ä½³ä»£ç†
- `POST /api/v1/proxy/test` - æµ‹è¯•ä»£ç†
- `POST /api/v1/proxy/refresh` - åˆ·æ–°ä»£ç†åˆ—è¡¨
- `GET /api/v1/proxy/statistics` - è·å–ä»£ç†ç»Ÿè®¡

### ç³»ç»Ÿæ¥å£
- `GET /` - æœåŠ¡ä¿¡æ¯
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /info` - è¯¦ç»†ä¿¡æ¯

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Gateway   â”‚    â”‚   Web Interface â”‚    â”‚   Monitoring    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Data Source Service     â”‚
                    â”‚                           â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  Crawler Manager    â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  Proxy Manager      â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  Content Processor  â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  Database Manager   â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚        Data Layer         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ MongoDB â”‚ â”‚  Redis  â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ”¯æŒå¹³å°

- **ä»Šæ—¥å¤´æ¡** - æ–°é—»èµ„è®¯çˆ¬å–
- **ç™¾å®¶å·** - è‡ªåª’ä½“å†…å®¹çˆ¬å–  
- **å°çº¢ä¹¦** - ç”Ÿæ´»æ–¹å¼å†…å®¹çˆ¬å–
- **æ‰‹åŠ¨æ·»åŠ ** - æ”¯æŒå•ä¸ª/æ‰¹é‡/æ–‡ä»¶å¯¼å…¥
- **æ‰©å±•æ¥å£** - å¯æ’æ‹”çš„æ•°æ®æºæ‰©å±•

### åå°ç¦ç­–ç•¥

- **IPä»£ç†æ± ** - æ”¯æŒå…è´¹å’Œä»˜è´¹ä»£ç†
- **User-Agentè½®æ¢** - æ¨¡æ‹Ÿä¸åŒæµè§ˆå™¨
- **è¯·æ±‚é¢‘ç‡æ§åˆ¶** - æ™ºèƒ½å»¶è¿Ÿç­–ç•¥
- **éªŒè¯ç è¯†åˆ«** - è‡ªåŠ¨å¤„ç†éªŒè¯ç 
- **è´¦å·æ± ç®¡ç†** - å¤šè´¦å·è½®æ¢æœºåˆ¶

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
services/data-source/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                 # APIè·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ crawler.py      # çˆ¬è™«ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ content.py      # å†…å®¹ç®¡ç†æ¥å£
â”‚   â”‚   â””â”€â”€ proxy.py        # ä»£ç†ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ crawler/            # çˆ¬è™«æ¨¡å—
â”‚   â”‚   â””â”€â”€ crawler_manager.py
â”‚   â”œâ”€â”€ proxy/              # ä»£ç†æ¨¡å—
â”‚   â”‚   â””â”€â”€ proxy_manager.py
â”‚   â”œâ”€â”€ models/             # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ content.py
â”‚   â”œâ”€â”€ database/           # æ•°æ®åº“æ¨¡å—
â”‚   â”‚   â””â”€â”€ database.py
â”‚   â”œâ”€â”€ config/             # é…ç½®æ¨¡å—
â”‚   â”‚   â””â”€â”€ settings.py
â”‚   â””â”€â”€ main.py             # åº”ç”¨å…¥å£
â”œâ”€â”€ tests/                  # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/              # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ integration/       # é›†æˆæµ‹è¯•
â”œâ”€â”€ k8s/                   # Kubernetesé…ç½®
â”œâ”€â”€ docker/                # Dockeré…ç½®æ–‡ä»¶
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

### æ·»åŠ æ–°å¹³å°çˆ¬è™«

1. **åˆ›å»ºçˆ¬è™«ç±»**
   ```python
   class NewPlatformCrawler(BaseCrawler):
       async def crawl(self):
           # å®ç°å…·ä½“çˆ¬å–é€»è¾‘
           pass
   ```

2. **æ³¨å†Œçˆ¬è™«**
   ```python
   # åœ¨CrawlerManagerä¸­æ·»åŠ 
   self.crawler_classes[ContentSource.NEW_PLATFORM] = NewPlatformCrawler
   ```

3. **æ›´æ–°æ•°æ®æ¨¡å‹**
   ```python
   # åœ¨ContentSourceæšä¸¾ä¸­æ·»åŠ 
   NEW_PLATFORM = "new_platform"
   ```

### é…ç½®ç®¡ç†

ä½¿ç”¨Pydantic Settingsè¿›è¡Œé…ç½®ç®¡ç†ï¼Œæ”¯æŒï¼š
- ç¯å¢ƒå˜é‡è¦†ç›–
- åµŒå¥—é…ç½®ç»“æ„
- ç±»å‹éªŒè¯
- é»˜è®¤å€¼è®¾ç½®

### æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/unit/test_crawler_manager.py

# è¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration/

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=src --cov-report=html
```

## ğŸ“Š ç›‘æ§è¿ç»´

### å¥åº·æ£€æŸ¥

```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# è¯¦ç»†æœåŠ¡ä¿¡æ¯
curl http://localhost:8000/info
```

### æ—¥å¿—ç®¡ç†

æœåŠ¡ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼Œæ”¯æŒï¼š
- å¤šçº§åˆ«æ—¥å¿— (DEBUG/INFO/WARNING/ERROR)
- JSONæ ¼å¼è¾“å‡º (ç”Ÿäº§ç¯å¢ƒ)
- æ—¥å¿—è½®è½¬å’Œä¿ç•™ç­–ç•¥
- ELK Stacké›†æˆ

### æŒ‡æ ‡ç›‘æ§

- **PrometheusæŒ‡æ ‡** - é€šè¿‡ `/metrics` ç«¯ç‚¹æš´éœ²
- **è‡ªå®šä¹‰æŒ‡æ ‡** - çˆ¬è™«æˆåŠŸç‡ã€ä»£ç†å¯ç”¨æ€§ç­‰
- **Grafanaçœ‹æ¿** - å¯è§†åŒ–ç›‘æ§é¢æ¿

### æœåŠ¡å‘ç°

- **Consulé›†æˆ** - è‡ªåŠ¨æœåŠ¡æ³¨å†Œå’Œå‘ç°
- **å¥åº·æ£€æŸ¥** - å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€
- **è´Ÿè½½å‡è¡¡** - æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

ä¸»è¦é…ç½®é¡¹è¯´æ˜ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `SERVICE_ENVIRONMENT` | è¿è¡Œç¯å¢ƒ | `development` |
| `SERVICE_PORT` | æœåŠ¡ç«¯å£ | `8000` |
| `CRAWLER_MAX_CONCURRENT_CRAWLERS` | æœ€å¤§å¹¶å‘çˆ¬è™«æ•° | `10` |
| `CRAWLER_ENABLE_PROXY` | æ˜¯å¦å¯ç”¨ä»£ç† | `false` |
| `DB_MONGODB_URL` | MongoDBè¿æ¥URL | `mongodb://localhost:27017` |
| `DB_REDIS_URL` | Redisè¿æ¥URL | `redis://localhost:6379` |
| `LOG_LOG_LEVEL` | æ—¥å¿—çº§åˆ« | `INFO` |

å®Œæ•´é…ç½®å‚è€ƒ `.env.example` æ–‡ä»¶ã€‚

### ç”Ÿäº§ç¯å¢ƒé…ç½®

ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®ï¼š
- å¯ç”¨ä»£ç†æ±  (`CRAWLER_ENABLE_PROXY=true`)
- å¢åŠ å¹¶å‘æ•° (`CRAWLER_MAX_CONCURRENT_CRAWLERS=20`)
- ä½¿ç”¨JSONæ—¥å¿— (`LOG_JSON_LOGS=true`)
- å¯ç”¨ç›‘æ§ (`MONITOR_ENABLE_METRICS=true`)
- é…ç½®å®‰å…¨å¯†é’¥ (`SERVICE_SECRET_KEY`)

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **MongoDBè¿æ¥å¤±è´¥**
   - æ£€æŸ¥MongoDBæœåŠ¡çŠ¶æ€
   - ç¡®è®¤è¿æ¥URLå’Œè®¤è¯ä¿¡æ¯
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

2. **ä»£ç†è·å–å¤±è´¥**
   - æ£€æŸ¥ä»£ç†æºå¯ç”¨æ€§
   - éªŒè¯ä»£ç†é…ç½®
   - æŸ¥çœ‹ä»£ç†æµ‹è¯•æ—¥å¿—

3. **çˆ¬è™«ä»»åŠ¡å¡ä½**
   - æ£€æŸ¥ç›®æ ‡ç½‘ç«™çŠ¶æ€
   - æŸ¥çœ‹ç½‘ç»œè¿æ¥
   - æ£€æŸ¥åå°ç¦ç­–ç•¥

4. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - è°ƒæ•´å¹¶å‘çˆ¬è™«æ•°é‡
   - æ£€æŸ¥æ•°æ®å¤„ç†é€»è¾‘
   - ç›‘æ§MongoDBè¿æ¥æ± 

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs data-source-service

# è¿‡æ»¤é”™è¯¯æ—¥å¿—
docker-compose logs data-source-service | grep ERROR

# å®æ—¶ç›‘æ§æ—¥å¿—
docker-compose logs -f data-source-service
```

### æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ä¼˜åŒ–**
   - åˆ›å»ºåˆé€‚çš„ç´¢å¼•
   - ä½¿ç”¨è¿æ¥æ± 
   - å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

2. **çˆ¬è™«ä¼˜åŒ–**
   - è°ƒæ•´è¯·æ±‚é—´éš”
   - ä½¿ç”¨é«˜è´¨é‡ä»£ç†
   - å®ç°å¢é‡çˆ¬å–

3. **ç¼“å­˜ç­–ç•¥**
   - ä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
   - å®ç°å†…å®¹å»é‡ç¼“å­˜
   - ç¼“å­˜ä»£ç†æµ‹è¯•ç»“æœ

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-XX)
- âœ… å®Œæˆå¤šå¹³å°çˆ¬è™«æ”¯æŒ
- âœ… å®ç°ä»£ç†ç®¡ç†ç³»ç»Ÿ
- âœ… æ·»åŠ å†…å®¹ç®¡ç†æ¥å£
- âœ… æ”¯æŒDockerå’ŒKuberneteséƒ¨ç½²
- âœ… å®Œæˆç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
- âœ… æ·»åŠ å®Œæ•´çš„æµ‹è¯•è¦†ç›–

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](../../LICENSE) æ–‡ä»¶ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Pull Request æˆ–åˆ›å»º Issueï¼

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request