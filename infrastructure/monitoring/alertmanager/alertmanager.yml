# AlertManager é…ç½®æ–‡ä»¶
# Historical Text Project - å‘Šè­¦ç®¡ç†é…ç½®

global:
  # é»˜è®¤SMTPé…ç½®ï¼ˆç”¨äºé‚®ä»¶å‘Šè­¦ï¼‰
  smtp_smarthost: ${SMTP_HOST:smtp.gmail.com:587}
  smtp_from: ${ALERT_EMAIL_FROM:alerts@historical-text.com}
  smtp_auth_username: ${SMTP_USERNAME}
  smtp_auth_password: ${SMTP_PASSWORD}
  smtp_require_tls: true
  
  # å¤–éƒ¨URLé…ç½®
  http_config:
    tls_config:
      insecure_skip_verify: true
  
  # å…¨å±€æ ‡ç­¾
  external_labels:
    cluster: 'historical-text-prod'
    environment: '${ENVIRONMENT:production}'

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default-receiver'
  
  # åˆ†ç»„é…ç½®
  group_by: 
    - 'alertname'
    - 'cluster'
    - 'service'
  
  # åˆ†ç»„ç­‰å¾…æ—¶é—´ï¼ˆç­‰å¾…åŒç»„å‘Šè­¦ä¸€èµ·å‘é€ï¼‰
  group_wait: 10s
  
  # åˆ†ç»„é—´éš”ï¼ˆåŒç»„å‘Šè­¦çš„å‘é€é—´éš”ï¼‰
  group_interval: 10s
  
  # é‡å¤å‘Šè­¦é—´éš”ï¼ˆåŒä¸€å‘Šè­¦çš„é‡å¤å‘é€é—´éš”ï¼‰
  repeat_interval: 1h
  
  # å­è·¯ç”±é…ç½®
  routes:
    # ä¸¥é‡å‘Šè­¦è·¯ç”±ï¼ˆç«‹å³é€šçŸ¥ï¼‰
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: true
    
    # å®‰å…¨å‘Šè­¦è·¯ç”±
    - match:
        team: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 15m
      continue: true
    
    # ä¸šåŠ¡å‘Šè­¦è·¯ç”±
    - match_re:
        component: '(data-collection|data-processing|text-extraction)'
      receiver: 'business-alerts'
      group_interval: 5m
      repeat_interval: 30m
    
    # åŸºç¡€è®¾æ–½å‘Šè­¦è·¯ç”±
    - match_re:
        component: '(infrastructure|database|message-queue)'
      receiver: 'infrastructure-alerts'
      group_interval: 2m
      repeat_interval: 15m
    
    # å¼€å‘å›¢é˜Ÿå‘Šè­¦è·¯ç”±
    - match:
        team: development
      receiver: 'development-alerts'
      group_interval: 5m
      repeat_interval: 1h
    
    # æ•°æ®åº“å›¢é˜Ÿå‘Šè­¦è·¯ç”±
    - match:
        team: database
      receiver: 'database-alerts'
      group_interval: 3m
      repeat_interval: 30m
    
    # å¹³å°å›¢é˜Ÿå‘Šè­¦è·¯ç”±
    - match:
        team: platform
      receiver: 'platform-alerts'
      group_interval: 2m
      repeat_interval: 20m
    
    # ä¿¡æ¯çº§åˆ«å‘Šè­¦ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
    - match:
        severity: info
      receiver: 'info-alerts'
      group_interval: 10m
      repeat_interval: 4h

# æŠ‘åˆ¶è§„åˆ™ï¼ˆé˜²æ­¢å‘Šè­¦é£æš´ï¼‰
inhibit_rules:
  # å½“èŠ‚ç‚¹å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶è¯¥èŠ‚ç‚¹ä¸Šçš„å…¶ä»–æ‰€æœ‰å‘Šè­¦
  - source_match:
      alertname: NodeDown
    target_match_re:
      instance: '(.+)'
    equal: ['instance']
  
  # å½“æœåŠ¡å®Œå…¨å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„å“åº”æ—¶é—´å’Œé”™è¯¯ç‡å‘Šè­¦
  - source_match:
      alertname: ServiceDown
    target_match_re:
      alertname: '(HighResponseTime|HighErrorRate)'
    equal: ['job']
  
  # å½“ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³æ—¶ï¼ŒæŠ‘åˆ¶ç£ç›˜IOå‘Šè­¦
  - source_match:
      alertname: LowDiskSpace
      severity: critical
    target_match:
      alertname: HighDiskIOUsage
    equal: ['instance', 'device']
  
  # å½“æ•°æ®åº“è¿æ¥æ± æ»¡æ—¶ï¼ŒæŠ‘åˆ¶æ…¢æŸ¥è¯¢å‘Šè­¦
  - source_match_re:
      alertname: '(PostgreSQLHighConnections|RedisHighConnections|MongoDBHighConnections)'
    target_match_re:
      alertname: '(.+)SlowQueries'
    equal: ['instance']

# æ¥æ”¶è€…é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶è€…
  - name: 'default-receiver'
    email_configs:
      - to: '${DEFAULT_EMAIL_TO:admin@historical-text.com}'
        subject: '[å†å²æ–‡æœ¬é¡¹ç›®] {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Labels.alertname }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.job | default "æœªçŸ¥" }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Labels.runbook_url }}å¤„ç†æ‰‹å†Œ: {{ .Labels.runbook_url }}{{ end }}
          {{ end }}
        html: |
          <h2>å†å²æ–‡æœ¬é¡¹ç›®å‘Šè­¦é€šçŸ¥</h2>
          <table border="1" style="border-collapse: collapse;">
            <tr>
              <th>å‘Šè­¦åç§°</th>
              <th>çº§åˆ«</th>
              <th>æœåŠ¡</th>
              <th>æè¿°</th>
              <th>æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
            {{ range .Alerts }}
            <tr>
              <td>{{ .Labels.alertname }}</td>
              <td style="color: {{ if eq .Labels.severity "critical" }}red{{ else if eq .Labels.severity "warning" }}orange{{ else }}blue{{ end }}">{{ .Labels.severity }}</td>
              <td>{{ .Labels.job | default "æœªçŸ¥" }}</td>
              <td>{{ .Annotations.description }}</td>
              <td>{{ .StartsAt.Format "2006-01-02 15:04:05" }}</td>
              <td>
                {{ if .Labels.runbook_url }}<a href="{{ .Labels.runbook_url }}">å¤„ç†æ‰‹å†Œ</a>{{ end }}
                {{ if .Labels.dashboard_url }}<a href="{{ .Labels.dashboard_url }}">æŸ¥çœ‹ä»ªè¡¨æ¿</a>{{ end }}
              </td>
            </tr>
            {{ end }}
          </table>

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶è€…
  - name: 'critical-alerts'
    email_configs:
      - to: '${CRITICAL_EMAIL_TO:oncall@historical-text.com}'
        subject: '[ğŸš¨ CRITICAL] {{ .GroupLabels.alertname }} - {{ .GroupLabels.job }}'
        body: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦è­¦æŠ¥ï¼
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Labels.alertname }}
          æœåŠ¡: {{ .Labels.job }}
          å®ä¾‹: {{ .Labels.instance }}
          æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Labels.runbook_url }}
          å¤„ç†æ‰‹å†Œ: {{ .Labels.runbook_url }}
          {{ end }}
          {{ end }}
          
          è¯·ç«‹å³å¤„ç†ï¼
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        title: 'ğŸš¨ ä¸¥é‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Labels.alertname }}
          *æœåŠ¡*: {{ .Labels.job }}
          *å®ä¾‹*: {{ .Labels.instance }}
          *æè¿°*: {{ .Annotations.description }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        color: 'danger'
        send_resolved: true
    
    webhook_configs:
      - url: '${WEBHOOK_URL_CRITICAL}'
        http_config:
          bearer_token: '${WEBHOOK_TOKEN}'
        send_resolved: true

  # å®‰å…¨å‘Šè­¦æ¥æ”¶è€…
  - name: 'security-alerts'
    email_configs:
      - to: '${SECURITY_EMAIL_TO:security@historical-text.com}'
        subject: '[ğŸ”’ SECURITY] {{ .GroupLabels.alertname }}'
        body: |
          ğŸ”’ å®‰å…¨å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Labels.alertname }}
          æœåŠ¡: {{ .Labels.job | default "ç³»ç»Ÿ" }}
          å®ä¾‹: {{ .Labels.instance | default "æœªçŸ¥" }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          {{ if .Labels.client_ip }}æ¥æºIP: {{ .Labels.client_ip }}{{ end }}
          {{ if .Labels.user_id }}ç”¨æˆ·ID: {{ .Labels.user_id }}{{ end }}
          {{ end }}
          
          è¯·åŠæ—¶å¤„ç†å®‰å…¨äº‹ä»¶ï¼
    
    slack_configs:
      - api_url: '${SECURITY_SLACK_WEBHOOK_URL}'
        channel: '#security-alerts'
        title: 'ğŸ”’ å®‰å…¨å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Labels.alertname }}
          *æè¿°*: {{ .Annotations.description }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .Labels.client_ip }}*æ¥æºIP*: {{ .Labels.client_ip }}{{ end }}
          {{ end }}
        color: 'warning'

  # ä¸šåŠ¡å‘Šè­¦æ¥æ”¶è€…
  - name: 'business-alerts'
    email_configs:
      - to: '${BUSINESS_EMAIL_TO:business@historical-text.com}'
        subject: '[ğŸ“Š BUSINESS] {{ .GroupLabels.alertname }}'
        body: |
          ğŸ“Š ä¸šåŠ¡å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Labels.alertname }}
          æœåŠ¡: {{ .Labels.job }}
          ç»„ä»¶: {{ .Labels.component }}
          æè¿°: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#business-alerts'
        title: 'ğŸ“Š ä¸šåŠ¡å‘Šè­¦'
        color: 'warning'

  # åŸºç¡€è®¾æ–½å‘Šè­¦æ¥æ”¶è€…
  - name: 'infrastructure-alerts'
    email_configs:
      - to: '${INFRA_EMAIL_TO:infrastructure@historical-text.com}'
        subject: '[ğŸ–¥ï¸ INFRASTRUCTURE] {{ .GroupLabels.alertname }}'
        body: |
          ğŸ–¥ï¸ åŸºç¡€è®¾æ–½å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Labels.alertname }}
          èŠ‚ç‚¹: {{ .Labels.instance }}
          ç»„ä»¶: {{ .Labels.component | default "åŸºç¡€è®¾æ–½" }}
          æè¿°: {{ .Annotations.description }}
          å½“å‰å€¼: {{ .Annotations.value | default "N/A" }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#infrastructure-alerts'
        title: 'ğŸ–¥ï¸ åŸºç¡€è®¾æ–½å‘Šè­¦'
        color: '#ff9900'

  # å¼€å‘å›¢é˜Ÿå‘Šè­¦æ¥æ”¶è€…
  - name: 'development-alerts'
    email_configs:
      - to: '${DEV_EMAIL_TO:dev-team@historical-text.com}'
        subject: '[ğŸ’» DEV] {{ .GroupLabels.alertname }}'
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dev-alerts'
        title: 'ğŸ’» å¼€å‘å‘Šè­¦'
        color: 'good'

  # æ•°æ®åº“å›¢é˜Ÿå‘Šè­¦æ¥æ”¶è€…
  - name: 'database-alerts'
    email_configs:
      - to: '${DB_EMAIL_TO:dba@historical-text.com}'
        subject: '[ğŸ—„ï¸ DATABASE] {{ .GroupLabels.alertname }}'
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#database-alerts'
        title: 'ğŸ—„ï¸ æ•°æ®åº“å‘Šè­¦'
        color: '#9932cc'

  # å¹³å°å›¢é˜Ÿå‘Šè­¦æ¥æ”¶è€…
  - name: 'platform-alerts'
    email_configs:
      - to: '${PLATFORM_EMAIL_TO:platform@historical-text.com}'
        subject: '[âš™ï¸ PLATFORM] {{ .GroupLabels.alertname }}'
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#platform-alerts'
        title: 'âš™ï¸ å¹³å°å‘Šè­¦'
        color: '#2eb886'

  # ä¿¡æ¯çº§å‘Šè­¦æ¥æ”¶è€…
  - name: 'info-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#info-alerts'
        title: 'â„¹ï¸ ä¿¡æ¯å‘Šè­¦'
        color: '#36a64f'
        send_resolved: true

# æ—¶é—´çª—å£é…ç½®
time_intervals:
  # å·¥ä½œæ—¶é—´ï¼ˆå‘¨ä¸€åˆ°å‘¨äº” 9:00-18:00ï¼‰
  - name: working_hours
    time_intervals:
      - times:
        - start_time: '09:00'
          end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'Asia/Shanghai'
  
  # éå·¥ä½œæ—¶é—´
  - name: off_hours
    time_intervals:
      - times:
        - start_time: '18:00'
          end_time: '09:00'
        weekdays: ['monday:friday']
        location: 'Asia/Shanghai'
      - weekdays: ['saturday', 'sunday']
        location: 'Asia/Shanghai'
  
  # ç»´æŠ¤çª—å£ï¼ˆæ¯å‘¨æ—¥ 02:00-04:00ï¼‰
  - name: maintenance_window
    time_intervals:
      - times:
        - start_time: '02:00'
          end_time: '04:00'
        weekdays: ['sunday']
        location: 'Asia/Shanghai'