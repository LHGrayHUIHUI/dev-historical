{{/* AlertManager è‡ªå®šä¹‰æ¨¡æ¿ */}}
{{/* å†å²æ–‡æœ¬é¡¹ç›®å‘Šè­¦é€šçŸ¥æ¨¡æ¿ */}}

{{/* å®šä¹‰é¢œè‰²å‡½æ•° */}}
{{ define "__alert_severity_color" -}}
{{- if eq .Labels.severity "critical" -}}
#d73527
{{- else if eq .Labels.severity "warning" -}}
#ff9900
{{- else if eq .Labels.severity "info" -}}
#36a64f
{{- else -}}
#808080
{{- end -}}
{{- end }}

{{/* å®šä¹‰emojiå‡½æ•° */}}
{{ define "__alert_severity_emoji" -}}
{{- if eq .Labels.severity "critical" -}}
ğŸš¨
{{- else if eq .Labels.severity "warning" -}}
âš ï¸
{{- else if eq .Labels.severity "info" -}}
â„¹ï¸
{{- else -}}
ğŸ“¢
{{- end -}}
{{- end }}

{{/* å®šä¹‰æœåŠ¡iconå‡½æ•° */}}
{{ define "__service_icon" -}}
{{- if eq .Labels.component "infrastructure" -}}
ğŸ–¥ï¸
{{- else if eq .Labels.component "database" -}}
ğŸ—„ï¸
{{- else if eq .Labels.component "authentication" -}}
ğŸ”
{{- else if eq .Labels.component "data-collection" -}}
ğŸ“Š
{{- else if eq .Labels.component "text-processing" -}}
ğŸ“
{{- else if eq .Labels.component "file-scanning" -}}
ğŸ”
{{- else if eq .Labels.component "message-queue" -}}
ğŸ“¬
{{- else -}}
âš™ï¸
{{- end -}}
{{- end }}

{{/* Slacké€šç”¨æ¨¡æ¿ */}}
{{ define "slack.title" }}
{{ template "__alert_severity_emoji" . }} {{ .Status | toUpper }} {{ if eq .Status "firing" }}{{ .Alerts | len }}{{ else }}å‘Šè­¦å·²æ¢å¤{{ end }}
{{- end }}

{{ define "slack.text" }}
{{ range .Alerts }}
{{ template "__service_icon" . }} *æœåŠ¡*: {{ .Labels.job | default "ç³»ç»Ÿ" }}
*å‘Šè­¦*: {{ .Labels.alertname }}
{{ if .Labels.instance }}*å®ä¾‹*: {{ .Labels.instance }}{{ end }}
*æè¿°*: {{ .Annotations.description | default .Annotations.summary }}
{{ if .Labels.severity }}*çº§åˆ«*: {{ .Labels.severity | upper }}{{ end }}
*æ—¶é—´*: {{ if eq .Status "firing" }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ else }}{{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
{{ if .Annotations.runbook_url }}*å¤„ç†æ‰‹å†Œ*: {{ .Annotations.runbook_url }}{{ end }}
{{ if .Annotations.dashboard_url }}*ä»ªè¡¨æ¿*: {{ .Annotations.dashboard_url }}{{ end }}

{{ end }}
{{- end }}

{{/* é‚®ä»¶ä¸»é¢˜æ¨¡æ¿ */}}
{{ define "email.subject" }}
[{{ .GroupLabels.environment | upper | default "PROD" }}] {{ template "__alert_severity_emoji" (index .Alerts 0) }} {{ .GroupLabels.alertname }} - {{ .GroupLabels.job | default "ç³»ç»Ÿ" }}
{{- end }}

{{/* é‚®ä»¶HTMLæ¨¡æ¿ */}}
{{ define "email.html" }}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å†å²æ–‡æœ¬é¡¹ç›®å‘Šè­¦é€šçŸ¥</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            margin-top: 10px;
        }
        .status-firing {
            background-color: #d73527;
            color: white;
        }
        .status-resolved {
            background-color: #36a64f;
            color: white;
        }
        .content {
            padding: 20px;
        }
        .alert-group {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        .alert-header {
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid #e0e0e0;
        }
        .alert-critical {
            background-color: #ffebee;
            color: #c62828;
        }
        .alert-warning {
            background-color: #fff8e1;
            color: #ef6c00;
        }
        .alert-info {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        .alert-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .alert-item:last-child {
            border-bottom: none;
        }
        .alert-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .detail-label {
            font-weight: bold;
            color: #555;
            width: 80px;
        }
        .detail-value {
            color: #333;
        }
        .actions {
            margin-top: 15px;
        }
        .action-link {
            display: inline-block;
            padding: 8px 15px;
            margin-right: 10px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
        }
        .action-link:hover {
            background-color: #0056b3;
        }
        .footer {
            background-color: #f8f9fa;
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 12px;
        }
        .metrics-summary {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .metric-item {
            text-align: center;
        }
        .metric-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ template "__service_icon" (index .Alerts 0) }} å†å²æ–‡æœ¬é¡¹ç›®å‘Šè­¦é€šçŸ¥</h1>
            <div class="status-badge {{ if eq .Status "firing" }}status-firing{{ else }}status-resolved{{ end }}">
                {{ if eq .Status "firing" }}{{ .Alerts | len }} ä¸ªå‘Šè­¦è§¦å‘{{ else }}å‘Šè­¦å·²æ¢å¤{{ end }}
            </div>
        </div>
        
        <div class="content">
            <!-- å‘Šè­¦æ‘˜è¦ -->
            <div class="metrics-summary">
                <h3>ğŸ“Š å‘Šè­¦æ‘˜è¦</h3>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-value">{{ .Alerts | len }}</div>
                        <div class="metric-label">æ€»å‘Šè­¦æ•°</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">
                            {{ $critical := 0 }}{{ range .Alerts }}{{ if eq .Labels.severity "critical" }}{{ $critical = add $critical 1 }}{{ end }}{{ end }}{{ $critical }}
                        </div>
                        <div class="metric-label">ä¸¥é‡å‘Šè­¦</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">
                            {{ $warning := 0 }}{{ range .Alerts }}{{ if eq .Labels.severity "warning" }}{{ $warning = add $warning 1 }}{{ end }}{{ end }}{{ $warning }}
                        </div>
                        <div class="metric-label">è­¦å‘Šå‘Šè­¦</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">{{ .GroupLabels.job | default "å¤šä¸ªæœåŠ¡" }}</div>
                        <div class="metric-label">å—å½±å“æœåŠ¡</div>
                    </div>
                </div>
            </div>
            
            <!-- å‘Šè­¦è¯¦æƒ… -->
            {{ range $index, $alert := .Alerts }}
            <div class="alert-group">
                <div class="alert-header alert-{{ .Labels.severity | default "info" }}">
                    {{ template "__alert_severity_emoji" . }} {{ .Labels.alertname }} 
                    {{ if .Labels.job }}({{ .Labels.job }}){{ end }}
                </div>
                <div class="alert-item">
                    <div class="alert-details">
                        {{ if .Labels.service }}<div class="detail-label">æœåŠ¡:</div><div class="detail-value">{{ .Labels.service }}</div>{{ end }}
                        {{ if .Labels.instance }}<div class="detail-label">å®ä¾‹:</div><div class="detail-value">{{ .Labels.instance }}</div>{{ end }}
                        {{ if .Labels.component }}<div class="detail-label">ç»„ä»¶:</div><div class="detail-value">{{ .Labels.component }}</div>{{ end }}
                        <div class="detail-label">çº§åˆ«:</div><div class="detail-value" style="color: {{ template "__alert_severity_color" . }}; font-weight: bold;">{{ .Labels.severity | upper | default "INFO" }}</div>
                        <div class="detail-label">å¼€å§‹æ—¶é—´:</div><div class="detail-value">{{ .StartsAt.Format "2006-01-02 15:04:05" }}</div>
                        {{ if ne .Status "firing" }}<div class="detail-label">ç»“æŸæ—¶é—´:</div><div class="detail-value">{{ .EndsAt.Format "2006-01-02 15:04:05" }}</div>{{ end }}
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong>æè¿°:</strong> {{ .Annotations.description | default .Annotations.summary }}
                    </div>
                    
                    {{ if .Annotations.value }}
                    <div style="margin-bottom: 10px;">
                        <strong>å½“å‰å€¼:</strong> <code>{{ .Annotations.value }}</code>
                    </div>
                    {{ end }}
                    
                    <div class="actions">
                        {{ if .Labels.runbook_url }}
                        <a href="{{ .Labels.runbook_url }}" class="action-link">ğŸ“– æŸ¥çœ‹å¤„ç†æ‰‹å†Œ</a>
                        {{ end }}
                        {{ if .Labels.dashboard_url }}
                        <a href="{{ .Labels.dashboard_url }}" class="action-link">ğŸ“Š æŸ¥çœ‹ä»ªè¡¨æ¿</a>
                        {{ end }}
                        {{ if .GeneratorURL }}
                        <a href="{{ .GeneratorURL }}" class="action-link">ğŸ”— æŸ¥çœ‹å‘Šè­¦æº</a>
                        {{ end }}
                    </div>
                </div>
            </div>
            {{ end }}
        </div>
        
        <div class="footer">
            <p>æ­¤é‚®ä»¶ç”±å†å²æ–‡æœ¬é¡¹ç›®ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨å‘é€ | å¦‚æœ‰é—®é¢˜è¯·è”ç³»è¿ç»´å›¢é˜Ÿ</p>
            <p>å‘é€æ—¶é—´: {{ .Status | title }} at {{ now.Format "2006-01-02 15:04:05" }}</p>
        </div>
    </div>
</body>
</html>
{{- end }}

{{/* é‚®ä»¶çº¯æ–‡æœ¬æ¨¡æ¿ */}}
{{ define "email.text" }}
å†å²æ–‡æœ¬é¡¹ç›®å‘Šè­¦é€šçŸ¥
===================

å‘Šè­¦çŠ¶æ€: {{ .Status | title }}
å‘Šè­¦ç»„: {{ .GroupLabels.alertname }}
{{ if .GroupLabels.job }}æœåŠ¡: {{ .GroupLabels.job }}{{ end }}
å‘Šè­¦æ•°é‡: {{ .Alerts | len }}

{{ range .Alerts }}
---
{{ template "__alert_severity_emoji" . }} å‘Šè­¦: {{ .Labels.alertname }}
{{ if .Labels.job }}æœåŠ¡: {{ .Labels.job }}{{ end }}
{{ if .Labels.instance }}å®ä¾‹: {{ .Labels.instance }}{{ end }}
{{ if .Labels.component }}ç»„ä»¶: {{ .Labels.component }}{{ end }}
çº§åˆ«: {{ .Labels.severity | upper | default "INFO" }}
æè¿°: {{ .Annotations.description | default .Annotations.summary }}
{{ if .Annotations.value }}å½“å‰å€¼: {{ .Annotations.value }}{{ end }}
å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
{{ if ne .Status "firing" }}ç»“æŸæ—¶é—´: {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
{{ if .Labels.runbook_url }}å¤„ç†æ‰‹å†Œ: {{ .Labels.runbook_url }}{{ end }}
{{ if .Labels.dashboard_url }}ä»ªè¡¨æ¿: {{ .Labels.dashboard_url }}{{ end }}

{{ end }}

æ­¤æ¶ˆæ¯ç”±å†å²æ–‡æœ¬é¡¹ç›®ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨å‘é€
å‘é€æ—¶é—´: {{ now.Format "2006-01-02 15:04:05" }}
{{- end }}

{{/* å¾®ä¿¡/ä¼ä¸šå¾®ä¿¡æ¨¡æ¿ */}}
{{ define "wechat.text" }}
{{ template "__alert_severity_emoji" (index .Alerts 0) }} å‘Šè­¦é€šçŸ¥

{{ if eq .Status "firing" }}ğŸ”´ {{ .Alerts | len }}ä¸ªå‘Šè­¦è§¦å‘{{ else }}ğŸŸ¢ å‘Šè­¦å·²æ¢å¤{{ end }}

{{ range .Alerts }}
ğŸ“‹ å‘Šè­¦: {{ .Labels.alertname }}
ğŸ·ï¸ æœåŠ¡: {{ .Labels.job | default "ç³»ç»Ÿ" }}
{{ if .Labels.instance }}ğŸ–¥ï¸ å®ä¾‹: {{ .Labels.instance }}{{ end }}
âš ï¸ çº§åˆ«: {{ .Labels.severity | upper }}
ğŸ“ æè¿°: {{ .Annotations.description }}
â° æ—¶é—´: {{ .StartsAt.Format "01-02 15:04" }}
{{ if .Labels.runbook_url }}ğŸ“– æ‰‹å†Œ: {{ .Labels.runbook_url }}{{ end }}

{{ end }}
{{- end }}