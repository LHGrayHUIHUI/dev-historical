# 📊 历史文本项目数据流向图 (ASCII版本)

## 🏗️ 整体系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                             前端层 (Frontend)                           │
├─────────────────────────┬───────────────────────────────────────────────┤
│     Vue 3 管理界面       │           API Gateway (Kong)                │
│         :3000           │               :8080                          │
└─────────────────────────┴───────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           微服务层 (Microservices)                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│              ┌─────────────────────────────────────────┐                │
│              │         Storage Service (:8002)        │                │
│              │           🔄 有状态核心服务              │                │
│              │      ┌─────────────────────────────┐    │                │
│              │      │   统一数据管理和API网关      │    │                │
│              │      └─────────────────────────────┘    │                │
│              └──────┬──────┬──────┬──────┬─────────────┘                │
│                     │      │      │      │                              │
│    ┌────────────────┴──┐ ┌─┴───┐ ┌─┴───┐ ┌─┴────────────────┐            │
│    │File Processor     │ │OCR  │ │NLP  │ │Image Processing  │            │
│    │     (:8001)       │ │(:8003)│(:8004)│     (:8005)      │            │
│    │  ⚡ 无状态计算     │ │⚡无状态│⚡无状态│    ⚡ 无状态       │            │
│    │                   │ │     │ │     │ │                  │            │
│    │• 文件格式转换      │ │• OCR │ │• NLP │ │• 图像增强         │            │
│    │• 内容提取         │ │• 识别 │ │• 分析 │ │• 去噪处理         │            │
│    │• 病毒扫描         │ │• 预处理│• 分词 │ │• 格式转换         │            │
│    └───────────────────┘ └─────┘ └─────┘ └──────────────────┘            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           存储层 (Storage Layer)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   MongoDB   │  │ PostgreSQL   │  │    Redis    │  │   MinIO     │    │
│  │   (:27018)  │  │   (:5433)    │  │   (:6380)   │  │ (:9001/9002)│    │
│  │             │  │              │  │             │  │             │    │
│  │ • 文档存储   │  │ • 元数据管理  │  │ • 缓存系统   │  │ • 文件存储   │    │
│  │ • 内容数据   │  │ • 用户管理    │  │ • 会话管理   │  │ • 备份存储   │    │
│  │ • 处理结果   │  │ • 审计日志    │  │ • 任务队列   │  │ • 静态资源   │    │
│  └─────────────┘  └──────────────┘  └─────────────┘  └─────────────┘    │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    RabbitMQ (:5672)                            │    │
│  │                     消息队列系统                                │    │
│  │  • 异步任务调度  • 事件通知  • 批量处理队列                      │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         监控层 (Monitoring Layer)                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐     │
│ │ Prometheus  │ │  Grafana    │ │   Jaeger    │ │   ELK Stack     │     │
│ │   (:9090)   │ │   (:3000)   │ │  (:16686)   │ │   (:5601)       │     │
│ │             │ │             │ │             │ │                 │     │
│ │ • 指标收集   │ │ • 监控面板   │ │ • 链路追踪   │ │ • 日志管理       │     │
│ │ • 告警规则   │ │ • 性能分析   │ │ • 性能分析   │ │ • 错误分析       │     │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 核心数据流向

### 1. 文件处理数据流

```
客户端请求 → Storage Service → File Processor
     │              │                │
     │              │                ├─► 文件验证
     │              │                ├─► 格式检查  
     │              │                ├─► 病毒扫描
     │              │                └─► 内容提取
     │              │                      │
     │              │ ◄──── 处理结果 ──────┘
     │              │
     │              ├─► MongoDB (保存文档内容)
     │              ├─► PostgreSQL (保存元数据)
     │              └─► MinIO (存储原始文件)
     │                      │
     └──── 处理完成响应 ◄────┘
```

### 2. OCR识别数据流

```
图像文件 → Storage Service → OCR Service
    │           │               │
    │           │               ├─► 图像预处理
    │           │               ├─► Tesseract识别
    │           │               ├─► PaddleOCR识别
    │           │               └─► 结果合并优化
    │           │                      │
    │           │ ◄──── 识别文本 ──────┘
    │           │
    │           ├─► Redis (缓存结果)
    │           ├─► MongoDB (保存文本)
    │           └─► PostgreSQL (记录日志)
    │                      │
    └── 识别结果返回 ◄──────┘
```

### 3. NLP分析数据流

```
文本内容 → Storage Service → NLP Service
    │           │               │
    │           │               ├─► 中文分词 (jieba)
    │           │               ├─► 词性标注 (spaCy)
    │           │               ├─► 实体识别 (HanLP)
    │           │               ├─► 情感分析 (Transformers)
    │           │               ├─► 关键词提取
    │           │               └─► 文本摘要
    │           │                      │
    │           │ ◄──── 分析结果 ──────┘
    │           │
    │           ├─► MongoDB (保存分析结果)
    │           ├─► Redis (缓存热点数据)
    │           └─► PostgreSQL (记录处理日志)
    │                      │
    └── 分析结果返回 ◄──────┘
```

### 4. 图像处理数据流

```
原始图像 → Storage Service → Image Processing Service
    │           │                      │
    │           │                      ├─► 质量评估
    │           │                      ├─► 图像增强
    │           │                      ├─► 去噪处理
    │           │                      ├─► 倾斜校正
    │           │                      ├─► 尺寸调整
    │           │                      └─► 格式转换
    │           │                           │
    │           │ ◄───── 处理后图像 ────────┘
    │           │
    │           ├─► MinIO (存储处理后图像)
    │           ├─► MongoDB (保存处理记录)
    │           └─► PostgreSQL (记录处理参数)
    │                      │
    └── 处理结果返回 ◄──────┘
```

## 🔗 服务间调用关系矩阵

```
服务调用关系:
                ┌─────────┬─────────┬─────────┬─────────┬─────────┐
调用方 ＼ 被调用方 │ Storage │ File    │ OCR     │ NLP     │ Image   │
                ├─────────┼─────────┼─────────┼─────────┼─────────┤
客户端/前端        │    ✅    │    ❌    │    ❌    │    ❌    │    ❌    │
Storage Service  │    -    │    ✅    │    ✅    │    ✅    │    ✅    │
File Processor   │    ❌    │    -    │    ❌    │    ❌    │    ❌    │
OCR Service      │    ❌    │    ❌    │    -    │    ❌    │    ❌    │
NLP Service      │    ❌    │    ❌    │    ❌    │    -    │    ❌    │
Image Processing │    ❌    │    ❌    │    ❌    │    ❌    │    -    │
                └─────────┴─────────┴─────────┴─────────┴─────────┘

✅ = 可以调用    ❌ = 不允许调用    - = 自身
```

## 📈 性能和扩展性设计

### 无状态服务水平扩展

```
负载均衡器 (Kong)
      │
      ├─── File Processor 实例 #1 (:8001)
      ├─── File Processor 实例 #2 (:8011)
      └─── File Processor 实例 #3 (:8021)

      ├─── OCR Service 实例 #1 (:8003)  
      ├─── OCR Service 实例 #2 (:8013)
      └─── OCR Service 实例 #3 (:8023)

      ├─── NLP Service 实例 #1 (:8004)
      └─── NLP Service 实例 #2 (:8014)

      ├─── Image Processing 实例 #1 (:8005)
      └─── Image Processing 实例 #2 (:8015)
```

### 异步处理队列

```
Storage Service → RabbitMQ → [批量处理任务队列]
                      │
                      ├─► OCR 批量识别队列
                      ├─► NLP 批量分析队列  
                      ├─► 图像批量处理队列
                      └─► 文件批量转换队列
```

---

## 🛡️ 安全架构

```
┌──────────────────────────────────────────────────────────┐
│                     安全边界                              │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 🔒 HTTPS/TLS 加密 → API Gateway → JWT 认证 → 服务调用     │
│                                                          │
│ 🔐 数据加密存储 ← Database Layer ← 访问控制 ← 权限验证     │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

*数据流向图版本: v2.3*  
*最后更新: 2025-09-08*  
*文档维护: Historical Text Project Team*