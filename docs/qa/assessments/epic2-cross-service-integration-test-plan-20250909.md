# Epic 2 跨服务集成测试和API调用测试方案

**日期**: 2025-09-09  
**设计师**: Quinn (测试架构师)  
**范围**: OCR、NLP、图像处理、知识图谱构建、智能分类五个微服务

## 测试策略概览

基于Epic 2的5个微服务架构，本方案专注于**跨服务集成测试**和**端到端API调用测试**：

- **跨服务集成测试**: 56个测试场景
- **API端到端测试**: 32个测试场景  
- **业务流程测试**: 24个测试场景
- **性能集成测试**: 18个测试场景
- **总计**: 130个集成测试场景

## 核心测试原则

1. **服务间通信验证**: 确保所有微服务之间的API调用稳定可靠
2. **数据一致性保证**: 验证跨服务数据传输的完整性和一致性
3. **业务流程完整性**: 验证历史文本处理的端到端业务流程
4. **故障恢复能力**: 测试服务间故障传播和恢复机制
5. **性能协同效应**: 验证多服务协作时的整体性能表现

## 服务依赖关系图

```
用户请求 → Storage Service (数据中心) ↔ {
    ├── OCR Service (图像文字识别)
    ├── NLP Service (文本处理)  
    ├── Image Processing Service (图像优化)
    ├── Knowledge Graph Service (知识抽取)
    └── Intelligent Classification Service (智能分类)
}
```

## 跨服务集成测试场景

### 类别1: OCR与其他服务集成测试

#### INT-CROSS-001: OCR → Storage Service 数据流

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| OCR结果存储验证 | CROSS-OCR-001 | P0 | OCR识别后数据存储到Storage | 数据完整性、存储格式 |
| OCR异步任务管理 | CROSS-OCR-002 | P0 | OCR异步任务状态同步 | 任务状态一致性 |
| OCR批量结果汇总 | CROSS-OCR-003 | P1 | 批量OCR结果统计分析 | 聚合数据准确性 |

#### INT-CROSS-002: OCR → NLP Service 协作流

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| OCR识别文本NLP处理 | CROSS-OCR-NLP-001 | P0 | OCR文本直接传递给NLP分析 | 文本传输无损耗 |
| 图像OCR+文本分词联合处理 | CROSS-OCR-NLP-002 | P0 | 图像识别后立即进行分词 | 处理时序正确性 |
| OCR质量与NLP准确性关联 | CROSS-OCR-NLP-003 | P1 | 低质量OCR对NLP影响测试 | 错误传播控制 |

#### INT-CROSS-003: OCR → Knowledge Graph 知识抽取

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| OCR古文本实体抽取 | CROSS-OCR-KG-001 | P0 | OCR识别古文后实体抽取 | 古文实体识别准确性 |
| 图文混合知识图谱构建 | CROSS-OCR-KG-002 | P1 | 图像和文本结合构建图谱 | 多模态知识整合 |

#### INT-CROSS-004: OCR → Classification 分类集成

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| OCR文本自动分类 | CROSS-OCR-CLS-001 | P0 | OCR识别文本直接分类 | 分类准确性 |
| 图像质量对分类影响 | CROSS-OCR-CLS-002 | P1 | 不同OCR质量的分类效果 | 质量影响评估 |

### 类别2: NLP与其他服务集成测试

#### INT-CROSS-005: NLP → Storage Service 数据管理

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| NLP结果结构化存储 | CROSS-NLP-001 | P0 | 分词、词性等结果存储 | 结构化数据完整性 |
| NLP批量任务监控 | CROSS-NLP-002 | P0 | 批量NLP任务状态跟踪 | 任务监控准确性 |
| NLP历史结果查询 | CROSS-NLP-003 | P1 | 历史NLP处理结果检索 | 查询性能和准确性 |

#### INT-CROSS-006: NLP → Knowledge Graph 协作

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| NLP预处理+实体抽取 | CROSS-NLP-KG-001 | P0 | NLP分词后实体识别 | 分词对实体抽取帮助 |
| 词性标注辅助关系抽取 | CROSS-NLP-KG-002 | P0 | 词性信息辅助关系识别 | 语法信息利用效果 |
| NLP语义分析+图谱推理 | CROSS-NLP-KG-003 | P1 | 语义分析结合图谱推理 | 深层语义理解验证 |

#### INT-CROSS-007: NLP → Classification 文本分类

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| NLP特征+机器学习分类 | CROSS-NLP-CLS-001 | P0 | NLP特征作为分类输入 | 特征质量对分类影响 |
| 情感分析+文档分类结合 | CROSS-NLP-CLS-002 | P1 | 情感特征辅助文档分类 | 多维特征融合效果 |
| 关键词提取+主题分类 | CROSS-NLP-CLS-003 | P1 | 关键词用于主题分类 | 关键词分类相关性 |

### 类别3: 图像处理服务集成测试

#### INT-CROSS-008: Image Processing → OCR 图像优化

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| 图像增强+OCR识别联合 | CROSS-IMG-OCR-001 | P0 | 图像预处理提升OCR效果 | 处理后OCR准确性提升 |
| 批量图像预处理+OCR | CROSS-IMG-OCR-002 | P0 | 批量图像优化后批量OCR | 批量处理效率和质量 |
| 图像质量评估+OCR选择 | CROSS-IMG-OCR-003 | P1 | 根据图像质量选择OCR策略 | 自适应处理策略效果 |

#### INT-CROSS-009: Image Processing → Storage 存储管理

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| 处理前后图像版本管理 | CROSS-IMG-001 | P0 | 原图和处理后图像版本控制 | 版本管理完整性 |
| 图像处理元数据存储 | CROSS-IMG-002 | P1 | 处理参数和质量指标存储 | 元数据准确性 |

### 类别4: 知识图谱服务集成测试

#### INT-CROSS-010: Knowledge Graph → Storage 图谱管理

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| 图谱结构存储验证 | CROSS-KG-001 | P0 | 复杂图谱结构完整存储 | 图结构完整性 |
| 图谱版本和更新管理 | CROSS-KG-002 | P0 | 图谱增量更新机制 | 版本控制和增量更新 |
| 大规模图谱查询性能 | CROSS-KG-003 | P1 | 大规模图谱查询响应性能 | 查询性能优化 |

#### INT-CROSS-011: Knowledge Graph → Classification 知识辅助分类

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| 实体知识辅助文档分类 | CROSS-KG-CLS-001 | P1 | 实体信息辅助文档分类 | 知识增强分类效果 |
| 关系图谱辅助主题发现 | CROSS-KG-CLS-002 | P2 | 关系网络发现主题类别 | 图谱结构分析能力 |

### 类别5: 智能分类服务集成测试

#### INT-CROSS-012: Classification → Storage 分类管理

| 测试场景 | 测试ID | 优先级 | 描述 | 验证点 |
|----------|--------|--------|------|--------|
| 分类模型版本管理 | CROSS-CLS-001 | P0 | 模型训练和版本控制 | 模型管理完整性 |
| 分类结果和统计存储 | CROSS-CLS-002 | P0 | 分类结果持久化存储 | 结果数据完整性 |
| 训练数据管理验证 | CROSS-CLS-003 | P1 | 训练数据集版本管理 | 数据版本控制 |

## 端到端业务流程测试

### 流程1: 完整古籍数字化处理流程

| 流程测试ID | 优先级 | 业务流程描述 | 涉及服务 | 验证目标 |
|------------|--------|------------|----------|----------|
| E2E-FLOW-001 | P0 | 古籍图像→增强→OCR→NLP→存储 | Image + OCR + NLP + Storage | 完整文本提取链路 |
| E2E-FLOW-002 | P0 | 古籍处理→知识抽取→图谱构建 | OCR + NLP + KG + Storage | 知识图谱构建链路 |
| E2E-FLOW-003 | P0 | 文档处理→特征提取→智能分类 | OCR + NLP + Classification | 智能分类完整链路 |

### 流程2: 批量文档处理业务流程

| 流程测试ID | 优先级 | 业务流程描述 | 涉及服务 | 验证目标 |
|------------|--------|------------|----------|----------|
| E2E-BATCH-001 | P0 | 批量图像处理→OCR→存储 | Image + OCR + Storage | 批量处理效率 |
| E2E-BATCH-002 | P1 | 批量文本NLP→分类→统计 | NLP + Classification + Storage | 批量分析能力 |
| E2E-BATCH-003 | P1 | 批量知识抽取→图谱更新 | NLP + KG + Storage | 增量知识构建 |

### 流程3: 异步任务协调流程

| 流程测试ID | 优先级 | 业务流程描述 | 涉及服务 | 验证目标 |
|------------|--------|------------|----------|----------|
| E2E-ASYNC-001 | P0 | 异步OCR→异步NLP→结果汇总 | OCR + NLP + Storage | 异步任务协调 |
| E2E-ASYNC-002 | P1 | 异步图谱构建→异步分类 | KG + Classification + Storage | 异步依赖处理 |

## 性能集成测试场景

### 性能测试类别1: 并发处理能力

| 性能测试ID | 测试场景 | 并发量 | 成功标准 | 涉及服务 |
|------------|----------|---------|-----------|-----------|
| PERF-CONC-001 | 并发OCR+NLP处理 | 100 | 响应时间<5s, 成功率>95% | OCR + NLP |
| PERF-CONC-002 | 并发图像处理+OCR | 50 | 处理时间<10s, 成功率>90% | Image + OCR |
| PERF-CONC-003 | 并发知识抽取+分类 | 30 | 响应时间<15s, 成功率>95% | KG + Classification |

### 性能测试类别2: 大数据量处理

| 性能测试ID | 测试场景 | 数据量 | 成功标准 | 涉及服务 |
|------------|----------|---------|-----------|-----------|
| PERF-BULK-001 | 批量文档完整处理 | 1000文档 | 完成时间<2小时 | 全部服务 |
| PERF-BULK-002 | 大规模图谱构建 | 10000实体 | 构建时间<1小时 | NLP + KG |
| PERF-BULK-003 | 批量分类训练 | 5000样本 | 训练时间<30分钟 | Classification |

### 性能测试类别3: 内存和资源利用

| 性能测试ID | 测试场景 | 资源限制 | 成功标准 | 涉及服务 |
|------------|----------|----------|-----------|-----------|
| PERF-MEM-001 | 内存限制下的处理能力 | 4GB限制 | 处理成功率>80% | 全部服务 |
| PERF-CPU-001 | CPU密集型任务处理 | 2核限制 | 吞吐量>预期50% | 计算密集服务 |

## 故障恢复和容错测试

### 故障注入测试场景

| 故障测试ID | 故障类型 | 注入位置 | 预期行为 | 恢复验证 |
|------------|----------|----------|-----------|-----------|
| FAULT-001 | Storage服务中断 | Storage连接 | 其他服务降级运行 | 自动重连和数据同步 |
| FAULT-002 | OCR服务超时 | OCR处理 | 任务重试或失败标记 | 任务状态正确更新 |
| FAULT-003 | 网络分区故障 | 服务间通信 | 熔断机制激活 | 网络恢复后自动恢复 |
| FAULT-004 | 内存溢出 | NLP/KG处理 | 优雅降级处理 | 资源释放和重启 |

## 数据一致性测试

### 数据一致性验证场景

| 一致性测试ID | 测试场景 | 验证点 | 成功标准 |
|-------------|-----------|--------|-----------|
| CONS-001 | 跨服务事务一致性 | 分布式事务处理 | 数据最终一致性 |
| CONS-002 | 异步任务数据一致性 | 任务状态同步 | 状态一致无冲突 |
| CONS-003 | 缓存数据一致性 | 缓存与数据库同步 | 缓存命中率>90%且数据一致 |

## 安全和权限测试

### 跨服务安全测试场景

| 安全测试ID | 测试场景 | 安全点 | 验证标准 |
|------------|----------|---------|-----------|
| SEC-001 | 服务间认证授权 | API调用权限 | 未授权调用被拒绝 |
| SEC-002 | 数据传输安全 | 敏感数据传输 | 数据加密传输 |
| SEC-003 | 接口参数验证 | 恶意参数注入 | 参数验证和过滤 |

## 监控和可观测性测试

### 监控集成测试场景

| 监控测试ID | 测试场景 | 监控指标 | 验证标准 |
|------------|----------|-----------|-----------|
| MON-001 | 跨服务链路追踪 | 请求链路跟踪 | 完整链路可见性 |
| MON-002 | 服务健康监控 | 健康状态检查 | 故障及时发现和报警 |
| MON-003 | 业务指标监控 | 处理量和成功率 | 实时业务指标准确 |

## 测试环境要求

### 环境配置
- **基础设施**: Docker Compose或Kubernetes集群
- **数据库**: MongoDB, PostgreSQL, Redis完整配置
- **存储**: MinIO对象存储
- **监控**: Prometheus + Grafana监控栈
- **网络**: 服务发现和负载均衡配置

### 测试数据要求
- **古籍图像样本**: 不同质量、尺寸、格式的历史文献图像
- **标准文本数据**: 已标注的古文和现代文档
- **知识图谱数据**: 历史人物、地名、事件关系数据
- **分类标签数据**: 多层次的文档分类体系

## 测试执行计划

### 第一阶段 - 基础集成测试 (1-2周)
1. 服务间基础通信测试
2. 数据存储和检索集成测试  
3. 核心业务流程端到端测试

### 第二阶段 - 高级功能集成测试 (2-3周)
1. 异步任务协调测试
2. 批量处理性能测试
3. 故障恢复能力测试

### 第三阶段 - 生产准备测试 (1-2周)
1. 大规模压力测试
2. 长时间稳定性测试
3. 监控和运维功能测试

## 成功标准和质量门

### 总体成功标准
- **P0测试通过率**: 100%
- **P1测试通过率**: 95%
- **端到端业务流程**: 100%成功
- **性能基线达标**: 满足预定义性能指标
- **故障恢复测试**: 90%以上场景自动恢复

### 质量门控制点
1. **基础集成测试通过**: 允许进入高级功能测试
2. **性能测试达标**: 允许进入生产准备测试  
3. **完整测试套件通过**: 允许生产部署

---

**备注**: 本集成测试方案重点关注Epic 2微服务之间的协作能力和整体系统的稳定性。所有测试应在接近生产环境的测试环境中执行，确保测试结果的可信度。特别关注历史文献处理的专业准确性和大规模数据处理的性能表现。